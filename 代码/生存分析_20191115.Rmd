---
title: "生存分析"
output: html_document
---

```{r}
rm=list(ls())
library(data.table)
library(survival)
library(survminer)
library(stringr)

#黑色素瘤网络数据
dataNet<-read.csv(file = "E:/data_melanoma/net_mapped_with_gepia.csv",header = T,check.names = F)

m1<-max(dataNet$Number_of_Samples_Mutations,na.rm = T)
g1<-unique(dataNet[which(dataNet$Number_of_Samples_Mutations==m1),"hgnc_symbol"])#BRAF有最大的Number_of_Samples_Mutations

m2<-max(dataNet$Number_of_Samples_CNA,na.rm = T)
g2<-unique(dataNet[which(dataNet$Number_of_Samples_CNA==m2),"hgnc_symbol"])#CDKN2A有最大的Nuber_of_Samples_CNA（缺失）

m3<-max(dataNet$log2FoldChange,na.rm = T)
g3<-unique(dataNet[which(dataNet$log2FoldChange==m3),"hgnc_symbol"])#SPP1有最大的log2FoldChange


#TCGA-SKCM数据集
dataTCGASKCM<-read.csv(file = "E:/data_melanoma/skcm_exp_TCGA_prep.csv",header = T,check.names = F) #19947个基因，473名病人
names(dataTCGASKCM)[1]<-"gene"
gene<-as.data.frame(tstrsplit(dataTCGASKCM$gene,"|",fixed = T))
names(gene)<-c("gene_symbol","entrez_id")
dataTCGASKCM$gene_symbol<-gene$gene_symbol
dataTCGASKCM$entrez_id<-gene$entrez_id

#病人临床信息
dataTCGAClin<-read.csv(file = "E:/data_melanoma/TCGA_dataClin.csv",header = T,check.names = F)

#TP53生存分析
dataSurv_TP53<-dataTCGAClin[,c("submitter_id","vital_status","days_to_death")]
dataSurv_TP53$read_count<-NA
for(i in 1:nrow(dataSurv_TP53)){
  for(j in 1:length(names(dataTCGASKCM)[2:474])){
    if(str_detect(names(dataTCGASKCM)[j],as.character(dataSurv_TP53$submitter_id[i]))){
      dataSurv_TP53$read_count[i]=dataTCGASKCM[dataTCGASKCM$gene_symbol=="TP53",j]
    }
  }
}

dataSurv_TP53<-dataSurv_TP53[!is.na(dataSurv_TP53$read_count),]


mTP53<-median(dataSurv_TP53$read_count)
dataSurv_TP53$group1<-NA
dataSurv_TP53$group1[dataSurv_TP53$read_count>mTP53]<-1
dataSurv_TP53$group1[dataSurv_TP53$read_count==mTP53]<-1
dataSurv_TP53$group1[dataSurv_TP53$read_count<mTP53]<-2

dataSurv_TP53$status<-NA
dataSurv_TP53$status[dataSurv_TP53$vital_status=="Dead"]<-2
dataSurv_TP53$status[dataSurv_TP53$vital_status=="Alive"]<-1

fit_TP53<-surv_fit(Surv(days_to_death,status)~group1,data = dataSurv_TP53)

pdf("Survival_TP53_20191115.pdf",onefile = F);
ggsurvplot(fit_TP53,pval = TRUE,
           linetype = "strata",
           conf.int = TRUE,
           surv.median.line = "hv",
           risk.table = TRUE,
           xlab = "Time(day)",
           legend = "top",
           legend.title = "read count",
           legend.labs = c("TP53=high","TP53=low"));#p值0.65
dev.off()


#BRAF生存分析
dataSurv_BRAF<-dataTCGAClin[,c("submitter_id","vital_status","days_to_death")]
dataSurv_BRAF$read_count<-NA
for(i in 1:nrow(dataSurv_BRAF)){
  for(j in 1:length(names(dataTCGASKCM)[2:474])){
    if(str_detect(names(dataTCGASKCM)[j],as.character(dataSurv_BRAF$submitter_id[i]))){
      dataSurv_BRAF$read_count[i]=dataTCGASKCM[dataTCGASKCM$gene_symbol=="BRAF",j]
    }
  }
}

dataSurv_BRAF<-dataSurv_BRAF[!is.na(dataSurv_BRAF$read_count),]


mBRAF<-median(dataSurv_BRAF$read_count)
dataSurv_BRAF$group1<-NA
dataSurv_BRAF$group1[dataSurv_BRAF$read_count>mBRAF]<-1
dataSurv_BRAF$group1[dataSurv_BRAF$read_count==mBRAF]<-1
dataSurv_BRAF$group1[dataSurv_BRAF$read_count<mBRAF]<-2

dataSurv_BRAF$status<-NA
dataSurv_BRAF$status[dataSurv_BRAF$vital_status=="Dead"]<-2
dataSurv_BRAF$status[dataSurv_BRAF$vital_status=="Alive"]<-1

fit_BRAF<-surv_fit(Surv(days_to_death,status)~group1,data = dataSurv_BRAF)

pdf("Survival_BRAF_20191115.pdf",onefile = F);
ggsurvplot(fit_BRAF,pval = TRUE,
           surv.median.line = "hv",
           risk.table = TRUE,
           conf.int = TRUE,
           linetype = "strata",
           xlab = "Time(day)",
           legend = "top",
           legend.title = "read count",
           legend.labs = c("BRAF=high","BRAF=low"))#p值0.0043
dev.off()


#CDKN2A生存分析
dataSurv_CDKN2A<-dataTCGAClin[,c("submitter_id","vital_status","days_to_death")]
dataSurv_CDKN2A$read_count<-NA
for(i in 1:nrow(dataSurv_CDKN2A)){
  for(j in 1:length(names(dataTCGASKCM)[2:474])){
    if(str_detect(names(dataTCGASKCM)[j],as.character(dataSurv_CDKN2A$submitter_id[i]))){
      dataSurv_CDKN2A$read_count[i]=dataTCGASKCM[dataTCGASKCM$gene_symbol=="CDKN2A",j]
    }
  }
}

dataSurv_CDKN2A<-dataSurv_CDKN2A[!is.na(dataSurv_CDKN2A$read_count),]


mCDKN2A<-median(dataSurv_CDKN2A$read_count)
dataSurv_CDKN2A$group1<-NA
dataSurv_CDKN2A$group1[dataSurv_CDKN2A$read_count>mCDKN2A]<-1
dataSurv_CDKN2A$group1[dataSurv_CDKN2A$read_count==mCDKN2A]<-1
dataSurv_CDKN2A$group1[dataSurv_CDKN2A$read_count<mCDKN2A]<-2

dataSurv_CDKN2A$status<-NA
dataSurv_CDKN2A$status[dataSurv_CDKN2A$vital_status=="Dead"]<-2
dataSurv_CDKN2A$status[dataSurv_CDKN2A$vital_status=="Alive"]<-1

fit_CDKN2A<-surv_fit(Surv(days_to_death,status)~group1,data = dataSurv_CDKN2A)


pdf("Survival_CDKN2A_20191115.pdf",onefile = F);
ggsurvplot(fit_CDKN2A,pval = TRUE,
           surv.median.line = "hv",
           risk.table = TRUE,
           conf.int = TRUE,
           linetype = "strata",
           xlab = "Time(day)",
           legend = "top",
           legend.title = "read count",
           legend.labs = c("CDKN2A=high","CDKN2A=low"))#p值0.14
dev.off()

#SPP1生存分析
dataSurv_SPP1<-dataTCGAClin[,c("submitter_id","vital_status","days_to_death")]
dataSurv_SPP1$read_count<-NA
for(i in 1:nrow(dataSurv_SPP1)){
  for(j in 1:length(names(dataTCGASKCM)[2:474])){
    if(str_detect(names(dataTCGASKCM)[j],as.character(dataSurv_SPP1$submitter_id[i]))){
      dataSurv_SPP1$read_count[i]=dataTCGASKCM[dataTCGASKCM$gene_symbol=="SPP1",j]
    }
  }
}

dataSurv_SPP1<-dataSurv_SPP1[!is.na(dataSurv_SPP1$read_count),]


mSPP1<-median(dataSurv_SPP1$read_count)
dataSurv_SPP1$group1<-NA
dataSurv_SPP1$group1[dataSurv_SPP1$read_count>mSPP1]<-1
dataSurv_SPP1$group1[dataSurv_SPP1$read_count==mSPP1]<-1
dataSurv_SPP1$group1[dataSurv_SPP1$read_count<mSPP1]<-2

dataSurv_SPP1$status<-NA
dataSurv_SPP1$status[dataSurv_SPP1$vital_status=="Dead"]<-2
dataSurv_SPP1$status[dataSurv_SPP1$vital_status=="Alive"]<-1

fit_SPP1<-surv_fit(Surv(days_to_death,status)~group1,data = dataSurv_SPP1)

pdf("Survival_SPP1_20191115
    .pdf",onefile = F);
ggsurvplot(fit_SPP1,pval = TRUE,
           surv.median.line = "hv",
           risk.table = TRUE,
           conf.int = TRUE,
           linetype = "strata",
           xlab = "Time(day)",
           legend = "top",
           legend.title = "read count",
           legend.labs = c("SPP1=high","SPP1=low"))#p值0.053
dev.off()
```

