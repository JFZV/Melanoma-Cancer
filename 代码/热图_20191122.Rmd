---
title: "热图"
output: html_document
---

```{r}
library(ComplexHeatmap)
library(circlize)
library(stringr)

d<-read.csv(file = "E:/data_melanoma/net_mapped_with_gepia.csv",header = TRUE)
d<-d[,c("hgnc_symbol","ensembl","Number_of_Samples_Mutations","CNA","Number_of_Samples_CNA","log2FoldChange")]
d<-d[!duplicated(d),]

glist1<-d[order(d$Number_of_Samples_Mutations,decreasing = TRUE),"hgnc_symbol"]
glist1<-glist1[!duplicated(glist1)]
#Number_of_Samples_Mutations最高的前10个基因
glist1a<-glist1[1:20]
#Number_of_Samples_Mutations最高的前200个基因
glist1b<-glist1[1:200]

glist2<-d[order(d$Number_of_Samples_CNA,decreasing = TRUE),"hgnc_symbol"]
glist2<-glist2[!duplicated(glist2)]
#Number_of_Samples_CNA最高的前10个基因
glist2a<-glist2[1:20]
#Number_of_Samples_CNA最高的前200个基因
glist2b<-glist2[1:200]

glist3<-d[order(abs(d$log2FoldChange),decreasing = TRUE),"hgnc_symbol"]
glist3<-glist3[!duplicated(glist3)]
#log2FoldChange绝对值最高的前10个基因
glist3a<-glist3[1:20]
#log2FoldChange绝对值最高的前200个基因
glist3b<-glist3[1:200]

guni<-union(glist1a,union(glist2a,glist3a))
gint<-intersect(glist1b,intersect(glist2b,glist3b))

dataSmNT<-read.csv("E:/data_melanoma/TCGA_SKCM_dataSmNT.csv",header = TRUE)#1
dataSmNT$sample_type<-paste0("NT",1:nrow(dataSmNT))
dataSmTP<-read.csv("E:/data_melanoma/TCGA_SKCM_dataSmTP.csv",header = TRUE)#103
dataSmTP$sample_type<-paste0("TP",1:nrow(dataSmTP))
dataSmTM<-read.csv("E:/data_melanoma/TCGA_SKCM_dataSmTM.csv",header = TRUE)#368
dataSmTM$sample_type<-paste0("TM",1:nrow(dataSmTM))
dataSmTAM<-read.csv("E:/data_melanoma/TCGA_SKCM_dataSmTAM.csv",header = TRUE)#1
dataSmTAM$sample_type<-paste0("TAM",1:nrow(dataSmTAM))

#TCGA samples
set.seed(2019)
dataSm<-rbind(dataSmNT,dataSmTP[sample(1:nrow(dataSmTP),10),],dataSmTM[sample(1:nrow(dataSmTM),10),],dataSmTAM)
colnames(dataSm)[1]<-"sample_id"

#TCGA expression data
expNorm<-read.csv("E:/data_melanoma/skcm_exp_TCGA_norm.csv",header = TRUE,check.names = FALSE,row.names = 1)

mat1<-matrix(nrow = length(guni),ncol = nrow(dataSm),dimnames = list(guni,dataSm$sample_type))
for(i in 1:nrow(mat1)){
  for(j in 1:ncol(mat1)){
    mat1[i,j]<-log10(expNorm[guni[i],dataSm$sample_id[j]]+0.1)
  }
}
write.csv(mat1,"E:/data_melanoma/前20基因并集.csv")

mat2<-matrix(nrow = length(gint),ncol = nrow(dataSm),dimnames = list(gint,dataSm$sample_type))
for(i in 1:nrow(mat2)){
  for(j in 1:ncol(mat2)){
    mat2[i,j]<-log10(expNorm[guni[i],dataSm$sample_id[j]]+0.1)
  }
}
write.csv(mat2,"E:/data_melanoma/前200基因交集.csv")

col_fun1<-colorRamp2(c(min(mat1,na.rm = TRUE),median(mat1,na.rm = TRUE),max(mat1,na.rm = TRUE)),c("green","white","purple"));
pdf("heatmap_gene_union.pdf");
ha = HeatmapAnnotation(type = factor(str_extract(colnames(mat1),"[A-Z]+")),annotation_legend_param = list(
  title = "Patient Type",
  at = c("TAM","NT","TM","TP"),
  labels = c("Additional Metastatic","Solid Tissue Normal","Metastatic","PRIMARY SOLID TUMOR")
));
ht1 = Heatmap(mat1,
        col = col_fun1,
        name = "log10(read count+0.1)",
        na_col = "black",
        border = TRUE,
        cluster_rows = FALSE,
        row_names_gp = gpar(fontsize = 8),
        column_split = factor(str_extract(colnames(mat1),"[A-Z]+")),
        show_parent_dend_line = FALSE,
        column_title_gp = gpar(fontsize = 8),
        column_gap = unit(2,"mm"),
        heatmap_legend_param = list(
          at = c(min(mat1,na.rm = TRUE),median(mat1,na.rm = TRUE),max(mat1,na.rm = TRUE)),
          labels = c("low","median","high"),
          title = "log10(read count+0.1)",
          legend_height = unit(4, "cm"),
          legend_direction = c("horizontal")),
        top_annotation = ha,
        );
draw(ht1,heatmap_legend_side = "bottom");
dev.off()

col_fun2<-colorRamp2(c(min(mat2,na.rm = TRUE),median(mat2,na.rm = TRUE),max(mat2,na.rm = TRUE)),c("green","white","purple"));
pdf("heatmap_gene_intersect.pdf");
ha = HeatmapAnnotation(type = factor(str_extract(colnames(mat2),"[A-Z]+")),annotation_legend_param = list(
  title = "Patient Type",
  at = c("TAM","NT","TM","TP"),
  labels = c("Additional Metastatic","Solid Tissue Normal","Metastatic","PRIMARY SOLID TUMOR")
));
ht2 = Heatmap(mat2,
        col = col_fun2,
        name = "log10(read count+0.1)",
        na_col = "black",
        border = TRUE,
        cluster_rows = FALSE,
        column_split = factor(str_extract(colnames(mat1),"[A-Z]+")),
        show_parent_dend_line = FALSE,
        column_title_gp = gpar(fontsize = 8),
        column_gap = unit(2,"mm"),
        heatmap_legend_param = list(
          at = c(min(mat2,na.rm = TRUE),median(mat2,na.rm = TRUE),max(mat2,na.rm = TRUE)),
          labels = c("low","median","high"),
          title = "log10(read count+0.1)",
          legend_height = unit(4, "cm"),
          legend_direction = c("horizontal")),
        top_annotation = ha,
        );
draw(ht2,heatmap_legend_side = "bottom");
dev.off()
```

